---
- name: set password
  command: "curl -X PUT http://172.17.42.1:8500/v1/kv/password -d {{db_password}}"

- name: copy cert
  copy:
    src: onelove.crt
    dest: /tmp/cert
    mode: 0644

- name: set cert
  command: curl -X PUT http://172.17.42.1:8500/v1/kv/loadbalancer/crt --data-binary @/tmp/cert

- name: remove cert from file system
  file:
    path: /tmp/cert
    state: absent

- name: copy key
  copy:
    src: onelove.key
    dest: /tmp/key
    mode: 0644

- name: set key
  command: curl -X PUT http://172.17.42.1:8500/v1/kv/loadbalancer/key --data-binary @/tmp/key

- name: remove key from file system
  file:
    path: /tmp/key
    state: absent

- name: add onelove services
  sudo: yes
  with_items: onelove_services
  template:
    src: "{{ item.name }}.service.j2"
    dest: "/lib/systemd/system/{{item.name}}.service"
    owner: root
    group: root

- name: reload systemd
  sudo: yes
  command: systemctl daemon-reload

- name: start onelove services
  sudo: yes
  with_items: onelove_services
  service:
    name: "{{ item.name }}"
    enabled: "{{ onelove_enable_service }}"
    state: started
